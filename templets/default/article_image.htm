<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<meta http-equiv="Content-Type" content="text/html; charset={dede:global.cfg_soft_lang/}" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>{dede:field.title/}_{dede:global.cfg_webname/}</title>
<meta name="keywords" content="{dede:field.keywords/}" />
<meta name="description" content="{dede:field.description function='html2text(@me)'/}" />
<meta http-equiv="mobile-agent" content="format=xhtml;url={dede:global.cfg_mobileurl/}/view.php?aid={dede:field.id/}">
<link href="{dede:global.cfg_templets_skin/}/style/Lnta-style.css" rel="stylesheet" media="screen" type="text/css" />
<link href="{dede:global.cfg_templets_skin/}/style/Lnta-mobile.css" rel="stylesheet" media="screen" type="text/css" />
<link href="{dede:global.cfg_templets_skin/}/style/image-carousel.css" rel="stylesheet" media="screen"
  type="text/css" />
<link href="{dede:global.cfg_templets_skin/}/style/feedback.css" rel="stylesheet" media="screen" type="text/css" />
<script language="javascript" type="text/javascript" src="{dede:global.cfg_cmsurl/}/include/dedeajax2.js"></script>
<script language="javascript" type="text/javascript">
  <!--
  function CheckLogin(){
    var taget_obj = document.getElementById('_ajax_feedback');
    myajax = new DedeAjax(taget_obj,false,false,'','','');
    myajax.SendGet2("{dede:global.cfg_cmsurl/}/member/ajax_feedback.php");
    DedeXHTTP = null;
  }
  function checkSubmit(){
    if(document.feedback.msg.value!='') document.feedback.submit();
    else alert("评论内容不能为空！");
  }
  function postBadGood(ftype,fid)
  {
    var taget_obj = document.getElementById(ftype+fid);
    var saveid = GetCookie('badgoodid');
    if(saveid != null)
    {
      var saveids = saveid.split(',');
      var hasid = false;
      saveid = '';
      j = 1;
      for(i=saveids.length-1;i>=0;i--)
      {
        if(saveids[i]==fid && hasid) continue;
        else {
          if(saveids[i]==fid && !hasid) hasid = true;
          saveid += (saveid=='' ? saveids[i] : ','+saveids[i]);
          j++;
          if(j==10 && hasid) break;
          if(j==9 && !hasid) break;
        }
      }
      if(hasid) { alert('您刚才已表决过了喔！'); return false;}
      else saveid += ','+fid;
      SetCookie('badgoodid',saveid,1);
    }
    else
    {
      SetCookie('badgoodid',fid,1);
    }
    myajax = new DedeAjax(taget_obj,false,false,'','','');
    myajax.SendGet2("{dede:field name='phpurl'/}/feedback.php?aid="+fid+"&action="+ftype+"&fid="+fid);
    DedeXHTTP = null;
  }
  function postDigg(ftype,aid) {
      var taget_obj = document.getElementById('newdigg');
      var saveid = GetCookie('diggid');
      var currentState = 0;
      
      // 解析当前状态
      if(saveid) {
          var states = saveid.split('|');
          for(var i = 0; i < states.length; i++) {
              var parts = states[i].split(':');
              if(parts[0] == aid) {
                  currentState = parseInt(parts[1]);
                  break;
              }
          }
      }
      
      // 计算新状态
      var newState = 0;
      if(ftype == 'good') {
          if(currentState == 1) newState = 0;  // 取消点赞
          else if(currentState == -1) {  // 从踩改为点赞
              newState = 1;
              // 先发送取消踩的请求
              var cancelUrl = "{dede:global.cfg_phpurl/}/digg_ajax.php?action=bad&id="+aid+"&state=0";
              var tempAjax = new DedeAjax(taget_obj,false,false,'','','');
              tempAjax.SendGet2(cancelUrl);
              DedeXHTTP = null;
          } else newState = 1;  // 首次点赞
      } else {
          if(currentState == -1) newState = 0;  // 取消踩
          else if(currentState == 1) {  // 从点赞改为踩
              newState = -1;
              // 先发送取消点赞的请求
              var cancelUrl = "{dede:global.cfg_phpurl/}/digg_ajax.php?action=good&id="+aid+"&state=0";
              var tempAjax = new DedeAjax(taget_obj,false,false,'','','');
              tempAjax.SendGet2(cancelUrl);
              DedeXHTTP = null;
          } else newState = -1;  // 首次踩
      }
      
      // 更新Cookie
      var newSaveid = '';
      if(saveid) {
          var states = saveid.split('|');
          var found = false;
          for(var i = 0; i < states.length; i++) {
              var parts = states[i].split(':');
              if(parts[0] == aid) {
                  if(newState != 0) {
                      newSaveid += (newSaveid ? '|' : '') + aid + ':' + newState;
                  }
                  found = true;
              } else {
                  newSaveid += (newSaveid ? '|' : '') + states[i];
              }
          }
          if(!found && newState != 0) {
              newSaveid += (newSaveid ? '|' : '') + aid + ':' + newState;
          }
      } else if(newState != 0) {
          newSaveid = aid + ':' + newState;
      }
      
      // 保存状态
      SetCookie('diggid', newSaveid, 30);  // 30天有效期
      
      // 发送AJAX请求
      myajax = new DedeAjax(taget_obj,false,false,'','','');
      var url = "{dede:global.cfg_phpurl/}/digg_ajax.php?action="+ftype+"&id="+aid+"&state="+newState;
      myajax.SendGet2(url);
      DedeXHTTP = null;
      
      // 更新显示
      updateDiggDisplay();
  }
  function getDigg(aid) {
      var taget_obj = document.getElementById('newdigg');
      myajax = new DedeAjax(taget_obj,false,false,'','','');
      myajax.SendGet2("{dede:global.cfg_phpurl/}/digg_ajax.php?id="+aid);
      DedeXHTTP = null;
      
      // 更新显示
      updateDiggDisplay();
  }
  function updateDiggDisplay() {
      var newdigg = document.getElementById('newdigg');
      if (!newdigg || !newdigg.textContent) return;
      
      try {
          var data = JSON.parse(newdigg.textContent);
          // 使用更精确的选择器
          var goodItem = document.querySelector('.stat-item[onclick*="postDigg(\'good\'"]');
          var badItem = document.querySelector('.stat-item[onclick*="postDigg(\'bad\'"]');
          
          if (goodItem && badItem) {
              // 更新Like数据
              goodItem.querySelector('.stat-value i').nextSibling.textContent = Math.floor(data.goodper) + '%';
              goodItem.querySelector('.stat-label').textContent = 'Like (' + data.goodpost + ')';
              // 更新Dislike数据
              badItem.querySelector('.stat-value i').nextSibling.textContent = Math.floor(data.badper) + '%';
              badItem.querySelector('.stat-label').textContent = 'Dislike (' + data.badpost + ')';
              
              // 更新按钮状态
              if(data.userState) {
                  // 移除所有active类
                  goodItem.classList.remove('active');
                  badItem.classList.remove('active');
                  // 根据状态添加active类
                  if(data.userState == 1) {
                      goodItem.classList.add('active');
                  } else if(data.userState == -1) {
                      badItem.classList.add('active');
                  }
              } else {
                  // 如果状态为0，移除所有active类
                  goodItem.classList.remove('active');
                  badItem.classList.remove('active');
              }
          }
      } catch (e) {
          console.error('Error updating digg display:', e);
      }
  }
  $(function() {
    $("#navigation .sort").click(function(){
      $(this).next(".menu").toggleClass("invisible");
      $(this).toggleClass("hover");
    })
    $(".scroll").jCarouselLite({})
  });
  function ChangePic(picsrc, imgid)
  {
    $(imgid).get(0).src = picsrc;
  }
  document.addEventListener('DOMContentLoaded', function () {
      // 获取文章ID
      var aid = document.querySelector('.stat-item[onclick*="postDigg"]').getAttribute('onclick').match(/\d+/)[0];
      
      // 立即获取并更新状态
      getDigg(aid);
    
  });
  //-->
</script>
</head>

<body class="articleview">

  <!---加载Nav-->
  {dede:include filename="head.htm"/}

<!--页面内容-->
<div class="page-wrapper pagtype" style="display: flex;">
  <div class="fillheight-1"></div>
  <div class="content-width">
    <div class="fillwidth-1"></div>

    <div class="image-carousel picbox" style="display:none;">
      <div class="carousel-container">
        {dede:field name='imgurls' alt='图片输出区'}
        <div class="carousel-item">
          <img src='[field:imgsrc/]' alt='[field:alttext /]' />
          <div class="carousel-caption">[field:alttext /]</div>
        </div>
        {/dede:field}
      </div>
    </div>

    <div class="default-img">
      <img class="project-header" alt="{dede:field.title/}" src="{dede:field.litpic/}">
    </div>
    <script>
        // 检查picbox元素中是否存在图片
        // 如果存在图片，显示picbox并隐藏default-img，同时设置content-area-1
        // 如果不存在图片，隐藏picbox并显示default-img，同时设置content-area-2
        document.addEventListener('DOMContentLoaded', function () {
          var picbox = document.querySelector('.picbox');
          var defaultImg = document.querySelector('.default-img');
          var pagtype = document.querySelector('.pagtype');
          var contentWidth = document.querySelector('.content-width');

          if (picbox.querySelector('img')) {
            picbox.style.display = 'block';
            defaultImg.style.display = 'none';
            pagtype.classList.remove('pagtype-arc');
            pagtype.classList.add('pagtype-img');
          } else {
            picbox.style.display = 'none';
            defaultImg.style.display = 'block';
            pagtype.classList.remove('pagtype-img');
            pagtype.classList.add('pagtype-arc');
          }

          // 添加show类来触发动画
          setTimeout(() => {
            contentWidth.classList.add('show');
          }, 100);
        });
    </script>

    <div class="content-area">
      <div class="fillwidth-3"></div>
      <h1><strong>{dede:field.title/}</strong></h1>
      <h2 class="project-description">{dede:field.description/}</h2>
      <div class="tags">
        <ul>{dede:tag}<li><a href='[field:link/]'>[field:tag /]</a></li>{/dede:tag}</ul>
      </div>
      <section class="Content-Type content-icon">
        {dede:field.body/}
      </section>

      <div class="fillwidth-1"></div>

      <!--- 作者信息区域 -->
      <div class="author-info">
        <div class="author-header">
          <span class="author-label">作者</span>
          <span class="author-name">{dede:field.writer/}</span>
        </div>
        <div class="author-description">
          {dede:arclist row='1' type='image.' titlelen='100' orderby=click}
          Popular: <a href="[field:arcurl/]">[field:title/]</a>
          {/dede:arclist}
        </div>
        <div class="author-stats">
          <div class="stat-item" onclick="javascript:postDigg('good',{dede:field.id/})">
            <span class="stat-value"><i class="iconfont">&#xe616;</i>{dede:field.goodper function='floor(@me)'/}%</span>
            <span class="stat-label">Like ({dede:field.goodpost/})</span>
          </div>
          <div class="stat-item" onclick="javascript:postDigg('bad',{dede:field.id/})">
            <span class="stat-value"><i class="iconfont">&#xe60f;</i>{dede:field.badper function='floor(@me)'/}%</span>
            <span class="stat-label">Dislike ({dede:field.badpost/})</span>
          </div>
          <div class="stat-item" id="comment-trigger">
            <span class="stat-value"><i class="iconfont">&#xe60e;</i>{dede:field.id runphp='yes'} global $dsql; $row = $dsql->GetOne("SELECT COUNT(*) AS num FROM dede_feedback WHERE aid=@me"); @me=$row['num']; {/dede:field.id}</span>
            <span class="stat-label" style="cursor: pointer;">Comment</span>
          </div>
        </div>
      </div>

      <div class="newdigg" id="newdigg" style="display:none;">
        <!--- 这个div用于AJAX更新数据 -->
      </div>

      <script language="javascript" type="text/javascript">getDigg({ dede: field.id /});</script>
      <!--- 对话开场白区域 -->
      <div class="conversation-starters">
        <h3>Reviews</h3>
        {dede:include file='ajaxfeedback.htm' /}
      </div>


      <div class="fillwidth-1"></div>

      <section class="next-shelf">
        <li class="project" style="max-width: 70%;">
          <a class="shelf-project-link" href="{dede:prenext get='preurl'/}">
            <h6 class="active" style="margin-bottom: 0;">Previous</h6>
            <div class="next-title">{dede:prenext get='prename'/}</div>
          </a>
        </li>
        <li class="project" style="text-align: right;max-width: 70%;">
          <a class="shelf-project-link" href="{dede:prenext get='nexturl'/}">
            <div class="next-title">{dede:prenext get='nextname'/}</div>
            <h6 class="active" style="margin-bottom: 0;">Next</h6>
          </a>
        </li>
      </section>
      <div class="fillwidth-1"></div>

    </div>
  </div>
</div>
<link href="{dede:global.cfg_templets_skin/}/style/image-preview.css" rel="stylesheet" media="screen" type="text/css" />
<script src="{dede:global.cfg_templets_skin/}/js/image-preview.js"></script>
<script src="{dede:global.cfg_templets_skin/}/js/image-caption.js"></script>
<script src="{dede:global.cfg_templets_skin/}/js/mobile-menu.js"></script>
<script src="{dede:global.cfg_templets_skin/}/js/image-carousel.js"></script>
</body>

</html>